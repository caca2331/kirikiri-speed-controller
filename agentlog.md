2025-12-07 17:51: Added SoundTouch runtime staging to build outputs, fixed the DSP pipeline to convert 16-bit PCM into SoundTouch's sample type (preventing heap crashes), and made KrkrSpeedController prompt for a speed so the console stays open. dsp_smoke now runs successfully with SoundTouch.dll present.
2025-12-07 19:18: Added toggleable temp-file logging (ENABLE_LOGGING), rebuilt KrkrSpeedController as a Win32 process picker with Hook + Apply injection and clamped speed input, and logged dsp_smoke scenarios; Release build succeeded and dsp_smoke still runs cleanly.
2025-12-07 19:48: Expanded speed clamp to 0.5–10x (default 1.0, recommend 0.75–2), filtered the process list to visible-window processes in the current session to avoid services/subprocesses, refreshed UI labels accordingly, and rebuilt Release successfully.
2025-12-07 20:16: Refactored the GUI into a dedicated module with tooltips, added length-gate checkbox + duration input (default 30s, validation with rollback), and wired XAudio2Hook to skip stretching buffers longer than the threshold; updated docs and verified Release build + dsp_smoke.
2025-12-07 20:58: Added architecture detection before injection so the GUI blocks mismatched bitness, and documented Win32/x64 build guidance in both README languages to prevent “DLL injection returned 0” errors.
2025-12-07 21:20: Taught the injector to auto-pick x86 vs x64 hook DLLs (searching x86/ and x64/ folders or suffixed names) and expanded README (EN/ZH) with dual-arch packaging layout so both 32-bit and 64-bit processes are supported.
2025-12-07 21:42: Added a CMake target+script (`dist_dual_arch`) to configure/build both x64 and x86 outputs, stage them into `dist/{x64,x86}`, documented the one-command workflow in README (EN/ZH), and ignored the generated dist/build.x86/build.x64 folders.
2025-12-07 22:30: Hardened injection diagnostics: pre-check hook DLL architecture against the target, ensure absolute DLL paths, and expanded LoadLibrary failure messaging; added README (EN/ZH) troubleshooting notes for “LoadLibrary returned 0”.
2025-12-07 23:01: Added a local preflight LoadLibrary check before injection to catch missing dependencies up front, surfacing the OS error code if the DLL cannot be loaded even in the controller process.
2025-12-08 00:05: Replaced hook stubs with working interception: patched IAT for XAudio2Create (2.7/2.8/2.9) and DirectSoundCreate8, vtable hooks for CreateSourceVoice/SubmitSourceBuffer/SetFrequencyRatio/DestroyVoice plus DirectSound buffer Unlock, routed PCM through the DSP with speed + length gate, and documented the active hooks in README (EN/ZH).
2025-12-08 00:17: Fixed XAudio2 hook declarations (correct callback type, static hook prototypes) and vtable patching by dereferencing to void** before writing, resolving MSVC compile errors; dual-arch Release build now completes.
2025-12-08 00:50: Hooked GetProcAddress to catch dynamically resolved XAudio2Create/DirectSoundCreate8, added setters/exposed hook stubs so x86 games that load audio APIs at runtime still get intercepted, and rebuilt dual-arch dist.
2025-12-08 01:24: Added SeDebugPrivilege enablement before injection and improved access-denied messaging, updated README (EN/ZH), and rebuilt dual-arch dist.
2025-12-08 01:45: Fixed LookupPrivilegeValueW call by passing a wide SE_DEBUG_NAME literal; dual-arch Release build succeeds (SoundTouch copy warning unchanged).
2025-12-08 02:08: Prevented the preflight DLL load from patching the controller’s GetProcAddress (KRKR_SKIP_HOOK_INIT guard) to avoid crashes on repeated “Hook + Apply”; rebuilt dual-arch dist.
2025-12-08 03:19: Added injection diagnostics and a short-path retry, appended arch details to failure status, and kept the preflight hook-skip in place; build rerun hit a dist copy lock (KrkrSpeedController.exe in use).
2025-12-08 03:19: Switched MSVC runtime to static (/MT) to remove VC++ redist dependency from the hook/GUI; dual-arch build now succeeds again.
2025-12-08 03:50: Added a fallback to copy the hook + SoundTouch into the target’s exe directory and retry injection (full + short paths), added per-attempt diagnostics, and recompiled (staging may fail if dist binaries are in use).
2025-12-08 04:00: Relaxed dual_arch staging to warn (not fail) if dist files are locked, using copy_if_different with remove-before-copy; build now completes even if an old controller is running.
2025-12-08 14:30: Added CoCreateInstance hook for XAudio2_7 (COM activation) and routed GetProcAddress to it so legacy XAudio2 games patch CreateSourceVoice; hoping to make actual tempo changes take effect.
2025-12-08 16:45: Fixed IXAudio2SourceVoice vtable patch indices (SubmitSourceBuffer/SetFrequencyRatio/DestroyVoice) so PCM actually flows through the DSP, added a shared-memory settings channel (Local\\KrkrSpeedSettings_<pid>) to propagate GUI speed/length gate into the injected DLL, and documented the change in README (EN/ZH).
2025-12-08 17:05: Fixed IXAudio2 CreateSourceVoice vtable index to 8 for XAudio2_7 so source voices get patched, rebuilt x86/x64 and restaged dist; should now see CreateSourceVoice/SubmitSourceBuffer hooks firing and tempo changes applying.
2025-12-08 17:25: Corrected IXAudio2SourceVoice vtable indices for XAudio2_7 (SubmitSourceBuffer=21, SetFrequencyRatio=26, DestroyVoice=18), rebuilt x86/x64 and restaged dist; expect source voices to be patched and speed changes to apply.
2025-12-08 17:42: Added bootstrap path that locates XAudio2Create manually, instantiates a dummy IXAudio2 and patches its vtable (CreateSourceVoice/SubmitSourceBuffer/SetFrequencyRatio/DestroyVoice), plus ensured indices 8/21/26/18; rebuilt x86/x64 and restaged dist so hooks engage even if the game never calls our XAudio2Create hook.
2025-12-08 17:58: Added COM-based bootstrap to create IXAudio2 if XAudio2Create isn’t resolved, patching vtables anyway; logs now warn when no DLL export is found. Rebuilt and restaged x86/x64 dist.
2025-12-08 18:20: Added retry loop that periodically re-attempts XAudio2 bootstrap (manual DLL lookup + COM fallback) until SubmitSourceBuffer is hooked, and logged first Submit engagement; rebuilt/restaged x86/x64 dist.
2025-12-08 18:45: Hooked LoadLibraryA/W to capture late-loaded XAudio2/DirectSound and set create pointers, added retry loop logging plus DirectSound UnlockHook first-hit log, and updated dual_arch staging to pull SoundTouch.dll from vcpkg if missing; rebuilt/restaged x86/x64.
2025-12-08 19:10: Added module-load notification via LdrRegisterDllNotification plus LoadLibraryEx hooks and module scanning to grab XAudio2/DirectSound even when loaded later, triggering bootstrap once XAudio2Create is found; fixed staging to include SoundTouch from vcpkg. Rebuilt/restaged x86/x64.
2025-12-08 20:05: Bootstrapped DirectSound vtable by creating a temp IDirectSound8 and patching CreateSoundBuffer globally; detoured DirectSoundCreate/8 exports for already-resolved pointers; rebuilt and restaged hook DLLs.
2025-12-09 00:10: Hardened DirectSound path: add log-only mode, skip primary/non-PCM buffers, guard invalid pointers, and fall back to passthrough if any DSP error triggers, then rebuilt/restaged dual-arch dist. Documented env toggles (KRKR_DS_LOG_ONLY, passthrough/skip flags, log dir) and clarified that `--target dist_dual_arch` drives both x86/x64 builds.
2025-12-09 00:20: Added a vectored exception handler to log the first few faults (code/address/module) for crash triage inside the hooked process; rebuilt/restaged x86/x64 dist.
2025-12-09 00:25: Added granular init-step logging around XAudio2/DirectSound/WaveOut initialization to pinpoint crash location; rebuilt/restaged x86/x64 dist.
2025-12-09 00:46: Added per-stage crash reporting (`stage=`) with opt-out for vectored handler (KRKR_DISABLE_VEH) and reordered init to detect earliest failing step; rebuilt/restaged x86/x64 dist.
2025-12-09 00:57: Wrapped module-dump logging in its own try/catch so init continues even if EnumProcessModules or name fetch throws; rebuilt/restaged x86/x64 dist.
2025-12-09 01:20: All env flags now only respect value \"1\"; added KRKR_SAFE_MODE (no hooks/patches), opt-in DirectSound via KRKR_ENABLE_DS, and documented the change; rebuilt/restaged x86/x64 dist.
2025-12-09 02:20: Made DirectSound vtable patch optional (KRKR_DS_DISABLE_VTABLE) and switched to per-instance shadow vtables for CreateSoundBuffer/Unlock; updated README and rebuilt/restaged x86/x64 dist.
2025-12-09 05:13: Throttled DirectSound Unlock debug spam, added DSP output-size diagnostics (pass-through detection), and rebuilt/restaged dual-arch binaries after SoundTouch receive loop fix.
2025-12-10 00:40: Tightened DirectSound BGM loop detection (needs >=2 loops and >=BGM_SECS playback), added env toggles `KRKR_DS_DISABLE_BGM`/`KRKR_DS_FORCE`, and copied rebuilt x86 Release binaries to dist/x86 for testing with KRKR_ENABLE_DS=1.
2025-12-10 01:05: Fixed DirectSound first-unlock passthrough by reprocessing newly tracked buffers in the same call (no more initial 1x), rebuilt x86 Release and restaged dist/x86.
2025-12-10 01:25: Made shared settings attach lazy (DirectSound-only runs now pick up GUI speed changes) and accelerated BGM loop detection (mark after ~1 loop/4 unlocks to avoid early zig-zag), rebuilt x86 Release and restaged dist/x86.
2025-12-10 01:45: Added duration-based BGM marking for small streaming buffers (>=BGM_SECS total, many unlocks) so BGM stops zig-zagging even when buffer size is small; rebuilt and restaged x86 binaries.
2025-12-10 02:05: Further sped up BGM detection: lowered loop threshold (gate*0.25, min 2s) and added early duration-based tagging for fast-churning small buffers (>=3–4s), rebuilt and restaged x86.
2025-12-10 02:20: Logged that BGM buffers in the game HaremKingdom were ~0.10s (17640 bytes at 44.1kHz stereo) with an initial 0.40s chunk; added a 0.5s minimum chunk length check to skip DSP on tiny buffers (commented in code), rebuilt/restaged x86.
2025-12-10 02:35: Relaxed the 0.5s skip so only the first sub-0.5s chunk is bypassed (once total>0.5s we process all chunks); rebuilt/restaged x86 for the second test game (tenshi_sz.exe) where 0.125s blocks needed DSP.
2025-12-10 02:50: Tightened BGM marking to only consider stereo or >=1.5s buffers; small mono voice buffers can no longer be mis-tagged as BGM. Rebuilt/restaged x86.
2025-12-10 03:05: Defaulted DirectSound freq-mode ON (unless KRKR_DS_USE_FREQ=0) so small 0.125s voice chunks speed up via SetFrequency + pitch compensate, reducing zig-zag gaps; rebuilt/restaged x86.
2025-12-10 03:25: Added a stereo-short heuristic: stereo chunks <=0.30s are marked BGM after 2 unlocks (unless disabled), so BGM stops speeding up immediately while mono voices keep processing; rebuilt/restaged x86.
2025-12-10 03:40: tenshi_sz.exe: voices (mono, 1.0s + 0.125s chunks) speed up correctly; BGM (stereo 0.125s chunks) stays at normal speed after the stereo-short heuristic.
2025-12-10 03:55: Enabled DirectSound hooks by default (opt-out with KRKR_SKIP_DS) so XAudio2-only games that actually use dsound still get processed; rebuilt/restaged x86.
2025-12-10 04:05: For the XAudio-fallback game, stopped processing stereo buffers unless forced (channels>1 treated as BGM) to prevent BGM speeding; rebuilt/restaged x86.
2025-12-10 04:20: Capped freq-mode to ratios <=2.0 (higher speeds fall back to tempo-only) to remove ‘aabbccdd’ stutter on tiny chunks; rebuilt/restaged x86.
2025-12-10 04:32: To fix high-speed stutter, capped freq-mode to <=2.0x and repeat DSP output to fill chunk when it returns short data (avoids zeros causing gaps); rebuilt/restaged x86.
2025-12-10 04:45: Documented the >2x voice repetition limitation in README (EN/ZH); advise users to stay at <=2x if they hear repeats.
